# Ræ ‘ç´¢å¼•

åœ¨**è½¦è”ç½‘ã€POI åˆ†æã€åœ°ç†å›´æ ã€è¡Œæ”¿åŒºåˆ’åˆ¤æ–­**ç­‰ä¸šåŠ¡ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šé‡åˆ°ä¸€ä¸ªéå¸¸åŸºç¡€ã€ä½†æå…¶é«˜é¢‘çš„é—®é¢˜ï¼š

> ğŸ‘‰ **ç»™å®šä¸€ä¸ªç»çº¬åº¦ç‚¹ï¼Œå®ƒå±äºå“ªä¸ªï¼ˆæˆ–å“ªäº›ï¼‰å¤šè¾¹å½¢ï¼Ÿ**

æ¯”å¦‚ï¼š

- ä¸€ä¸ª GPS ç‚¹å±äºå“ªä¸ªè¡Œæ”¿åŒºï¼Ÿ
- ä¸€ä¸ªè½¦è¾†è½¨è¿¹ç‚¹æ˜¯å¦è½åœ¨æŸä¸ªç‰©æµå›­å›´æ å†…ï¼Ÿ
- ä¸€ä¸ª POI æ˜¯å¦åœ¨è§„åˆ’çš„æœåŠ¡åŒºåŸŸä¸­ï¼Ÿ

è¿™ä¸ªé—®é¢˜åœ¨ GIS é¢†åŸŸè¢«ç§°ä¸ºï¼š**Point in Polygonï¼ˆPIPï¼‰é—®é¢˜**ã€‚

æœ¬æ–‡å°†ç»“åˆä¸€ä»½å®Œæ•´å¯è¿è¡Œçš„ Python ä»£ç ï¼Œä»ï¼š

- ç®—æ³•åŸç†
- å·¥ç¨‹å®ç°
- æ€§èƒ½ç“¶é¢ˆ
- åŠ é€Ÿæ‰‹æ®µï¼ˆåŒ…å›´ç›’ã€R æ ‘ï¼‰

å‡ ä¸ªå±‚é¢ï¼Œç³»ç»Ÿæ€§åœ°è®²æ¸…æ¥šï¼š**ç‚¹åœ¨å“ªä¸ªå¤šè¾¹å½¢é‡Œï¼Œåˆ°åº•è¯¥æ€ä¹ˆç®—ã€æ€ä¹ˆé€‰ã€æ€ä¹ˆå¿«ã€‚**



## ä¸€ã€æœ€åŸå§‹çš„æ–¹æ³•ï¼šé€ä¸ªå¤šè¾¹å½¢åˆ¤æ–­

### 1ï¸âƒ£ æ€è·¯

æœ€ç›´è§‚çš„æ–¹å¼æ˜¯ï¼š

- å¯¹æ¯ä¸€ä¸ªå¤šè¾¹å½¢
- åˆ¤æ–­ç‚¹æ˜¯å¦åœ¨è¿™ä¸ªå¤šè¾¹å½¢å†…éƒ¨

æ•°å­¦ä¸Šå¸¸è§çš„å®ç°æœ‰ï¼š

- å°„çº¿æ³•ï¼ˆRay Castingï¼‰

  > å®ƒè®¡ç®—ä»ç‚¹På¼€å§‹çš„å°„çº¿ç©¿è¿‡å¤šè¾¹å½¢è¾¹ç•Œçš„æ¬¡æ•°ã€‚å½“äº¤å‰æ•°æ˜¯å¶æ•°æ—¶ï¼Œç‚¹åœ¨å¤–é¢ï¼›å½“äº¤å‰æ•°æ˜¯å¥‡æ•°æ—¶ï¼Œç‚¹åœ¨é‡Œé¢ã€‚

  <img src="3-Ræ ‘ç´¢å¼•.assets\v2-bfad2b889754ad5248cd877655de2540_1440w.jpeg" alt="å¹³é¢å‡ ä½•ï¼šåˆ¤æ–­ç‚¹æ˜¯å¦åœ¨å¤šè¾¹å½¢å†…ï¼ˆå°„çº¿æ³•ï¼‰" style="zoom: 80%;" />

- ç¯ç»•æ•°æ³•ï¼ˆWinding Numberï¼‰

  > ä»–è®¡ç®—å¤šè¾¹å½¢å›´ç€ç‚¹Pæ—‹è½¬åœ°æ¬¡æ•°ï¼Œåªæœ‰å½“åœˆæ•°wn=0æ—¶ï¼Œç‚¹åœ¨å¤–é¢ï¼›å¦åˆ™ï¼Œç‚¹åœ¨é‡Œé¢ã€‚

  <img src="3-Ræ ‘ç´¢å¼•.assets\image-20260127155816374.png" alt="image-20260127155816374" style="zoom: 67%;" />

åœ¨å·¥ç¨‹ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ä¸ä¼šè‡ªå·±æ‰‹å†™å‡ ä½•ç®—æ³•ï¼Œè€Œæ˜¯ç›´æ¥ä½¿ç”¨æˆç†Ÿåº“ã€‚

### 2ï¸âƒ£ ä»£ç å®ç°

```python
def point_in_polygon(point_lon, point_lat, polygon_coords):
    """
    åˆ¤æ–­ä¸€ä¸ªç‚¹æ˜¯å¦åœ¨å¤šè¾¹å½¢å†…
    
    å‚æ•°:
        point_lon: ç‚¹çš„ç»åº¦ï¼ˆfloatï¼‰
        point_lat: ç‚¹çš„çº¬åº¦ï¼ˆfloatï¼‰
        polygon_coords: å¤šè¾¹å½¢é¡¶ç‚¹åˆ—è¡¨ï¼Œæ ¼å¼ä¸º [(lon1, lat1), (lon2, lat2), ...]
    
    è¿”å›:
        True: ç‚¹åœ¨å¤šè¾¹å½¢å†…
        False: ç‚¹ä¸åœ¨å¤šè¾¹å½¢å†…
    """
    # æ–¹å¼ä¸€ï¼šåŸºäºå°„çº¿æ³•
    import matplotlib.path as mplPath
	import numpy as np
    polygon = mplPath.Path(np.array(polygon_coords))
    return polygon.contains_point(point)
    
    # æ–¹å¼äºŒï¼šåŸºäºç¯ç»•æ•°æ³•
    from shapely.geometry import Point, Polygon
    point = Point(point_lon, point_lat)
    polygon = Polygon(polygon_coords)
    return polygon.contains(point)

	# æ–¹å¼ä¸‰ï¼šåŸºäºå°„çº¿æ³•
    import cv2
    cv2.pointPolygonTest(np.array(polygon_coords),point,measureDist=False)
```

å¦‚æœæœ‰å¤šä¸ªå¤šè¾¹å½¢ï¼š

```python
def find_point_in_polygons(point_lon, point_lat, polygons_dict):
    """
    æŸ¥æ‰¾ç‚¹æ‰€åœ¨çš„å¤šè¾¹å½¢ï¼ˆä¸ä½¿ç”¨ç´¢å¼•ï¼Œé€‚åˆå°æ•°æ®é›†ï¼‰
    
    å‚æ•°:
        point_lon: ç‚¹çš„ç»åº¦
        point_lat: ç‚¹çš„çº¬åº¦
        polygons_dict: å¤šè¾¹å½¢å­—å…¸
    
    è¿”å›:
        åŒ…å«è¯¥ç‚¹çš„å¤šè¾¹å½¢åç§°åˆ—è¡¨
    """
    point = Point(point_lon, point_lat)
    result = []
    
    for name, coords in polygons_dict.items():
        polygon = Polygon(coords)
        if polygon.contains(point):
            result.append(name)
    
    return result
```

### 3ï¸âƒ£ æ€§èƒ½åˆ†æ

- **æ—¶é—´å¤æ‚åº¦**ï¼šO(N)
- N = å¤šè¾¹å½¢æ•°é‡

å¦‚æœï¼š

- å¤šè¾¹å½¢æ•°é‡ < 100
- æŸ¥è¯¢ç‚¹æ•°é‡ä¸å¤š

ğŸ‘‰ **å®Œå…¨æ²¡é—®é¢˜ï¼Œç®€å•ã€æ¸…æ™°ã€å¥½ç»´æŠ¤ã€‚**

ä½†ä¸€æ—¦è¿›å…¥çœŸå®ä¸šåŠ¡åœºæ™¯ï¼š

- ä¸Šåƒ / ä¸Šä¸‡å›´æ 
- æ¯ç§’ä¸Šç™¾ / ä¸Šåƒç‚¹

**æ€§èƒ½ä¼šè¿…é€Ÿæˆä¸ºç“¶é¢ˆã€‚**



## äºŒã€ç¬¬ä¸€æ­¥åŠ é€Ÿï¼šåŒ…å›´ç›’ï¼ˆBounding Boxï¼‰è¿‡æ»¤

### 1ï¸âƒ£ æ ¸å¿ƒæ€æƒ³

ç»å¤§å¤šæ•°ç‚¹ï¼Œ
**è¿å¤šè¾¹å½¢çš„â€œå¤–æ¥çŸ©å½¢â€éƒ½ä¸åœ¨é‡Œé¢ã€‚**

é‚£æˆ‘ä»¬å°±å¯ä»¥ï¼š

1. å…ˆåˆ¤æ–­ç‚¹æ˜¯å¦åœ¨å¤šè¾¹å½¢çš„åŒ…å›´ç›’å†…ï¼ˆæå¿«ï¼‰
2. å†å¯¹â€œå¯èƒ½å‘½ä¸­â€çš„å°‘é‡å¤šè¾¹å½¢åšç²¾ç¡®åˆ¤æ–­

### 2ï¸âƒ£ ä»€ä¹ˆæ˜¯åŒ…å›´ç›’ï¼Ÿ

<img src="3-Ræ ‘ç´¢å¼•.assets\image-20260127163255197.png" alt="image-20260127163255197" style="zoom: 33%;" />

å¯¹ä¸€ä¸ªå¤šè¾¹å½¢ï¼š

```
(minx, miny, maxx, maxy)
```

åªè¦ï¼š

```
minx â‰¤ lon â‰¤ maxx
miny â‰¤ lat â‰¤ maxy
```

æ‰**æœ‰å¯èƒ½**åœ¨å¤šè¾¹å½¢å†…ã€‚

### 3ï¸âƒ£ ä»£ç ç»“æ„

```python
class PolygonIndexWithBounds:
    """
    ä½¿ç”¨åŒ…å›´ç›’å¿«é€Ÿè¿‡æ»¤çš„ç©ºé—´ç´¢å¼•
    """
    def __init__(self, polygons_dict):
        """åˆå§‹åŒ–åŒ…å›´ç›’ç´¢å¼•"""
        self.polygons = {}
        self.bounds_map = {}
        
        for name, coords in polygons_dict.items():
            polygon = Polygon(coords)
            self.polygons[name] = polygon
            self.bounds_map[name] = polygon.bounds
    
    def find_point_in_polygons(self, point_lon, point_lat):
        """æŸ¥æ‰¾ç‚¹æ‰€åœ¨çš„å¤šè¾¹å½¢"""
        point = Point(point_lon, point_lat)
        result = []

        # é€šè¿‡åŒ…å›´ç›’è¿‡æ»¤
        candidates = []
        for name, bounds in self.bounds_map.items():
            minx, miny, maxx, maxy = bounds
            if minx <= point_lon <= maxx and miny <= point_lat <= maxy:
                candidates.append(name)
        
        # ç²¾ç¡®æ£€æŸ¥
        for name in candidates:
            if self.polygons[name].contains(point):
                result.append(name)
        
        return result
    
    def find_points_in_polygons_batch(self, points_list):
        """æ‰¹é‡æŸ¥è¯¢"""
        results = []
        for lon, lat in points_list:
            polygons = self.find_point_in_polygons(lon, lat)
            results.append({"point": (lon, lat), "polygons": polygons})
        return results
```

### 4ï¸âƒ£ æ€§èƒ½æ•ˆæœ

- åŒ…å›´ç›’åˆ¤æ–­ï¼šçº¯æ•°å€¼æ¯”è¾ƒï¼Œæå¿«
- ç²¾ç¡®å‡ ä½•åˆ¤æ–­æ¬¡æ•°å¤§å¹…å‡å°‘

åœ¨æµ‹è¯•ä¸­ï¼š

> ğŸš€ **é€šå¸¸å¯æé€Ÿ 10 ~ 100 å€**

### 5ï¸âƒ£ é€‚ç”¨åœºæ™¯

- å¤šè¾¹å½¢æ•°é‡ï¼š**100 ~ 1000**
- å®ç°æˆæœ¬ä½
- ä¸ä¾èµ–é¢å¤–ç©ºé—´ç´¢å¼•åº“

ğŸ‘‰ **æ€§ä»·æ¯”æé«˜çš„å·¥ç¨‹æ–¹æ¡ˆ**



## ä¸‰ã€ç»ˆææ–¹æ¡ˆï¼šR æ ‘ï¼ˆSpatial Indexï¼‰

### 1ï¸âƒ£ é—®é¢˜å†å‡çº§

å½“ä½ é‡åˆ°ï¼š

- ä¸Šä¸‡ / æ•°åä¸‡å¤šè¾¹å½¢
- å®æ—¶æˆ–å‡†å®æ—¶æŸ¥è¯¢

åŒ…å›´ç›’ O(N) æ‰«æä¹Ÿå¼€å§‹åƒåŠ›ã€‚

è¿™æ—¶å€™ï¼Œå°±éœ€è¦çœŸæ­£çš„**ç©ºé—´ç´¢å¼•**ã€‚

------

### 2ï¸âƒ£ ä»€ä¹ˆæ˜¯ R æ ‘ï¼Ÿ

![img](3-Ræ ‘ç´¢å¼•.assets\20170410084844936.jpeg)

R æ ‘æ˜¯ä¸€ç§ï¼š

> **ä¸ºå¤šç»´ç©ºé—´æŸ¥è¯¢è®¾è®¡çš„æ ‘ç»“æ„**

ç‰¹ç‚¹ï¼š

- å¤šå±‚åŒ…å›´ç›’
- ç±»ä¼¼ B+ æ ‘çš„åˆ†å±‚ç»“æ„
- ä¸“ä¸ºâ€œç©ºé—´ç›¸äº¤ / åŒ…å«â€ä¼˜åŒ–

ä½ å¯ä»¥æŠŠå®ƒç†è§£ä¸ºï¼š

> **ç©ºé—´ä¸–ç•Œé‡Œçš„ç´¢å¼•ï¼ˆåƒæ•°æ®åº“ç´¢å¼•ä¸€æ ·ï¼‰**

------

### 3ï¸âƒ£ Shapely ä¸­çš„ R æ ‘

Shapely 2.x æä¾›äº† `STRtree`ï¼š

```python
from shapely.strtree import STRtree

tree = STRtree(geometry_list)
```

æŸ¥è¯¢æ—¶ï¼š

```python
candidates = tree.query(point, predicate='intersects')
```

å†è¿›è¡Œä¸€æ¬¡ç²¾ç¡®åˆ¤æ–­å³å¯ã€‚

```python
class PolygonIndexWithRtree:
    """
    ä½¿ç”¨Ræ ‘ç©ºé—´ç´¢å¼•çš„å¤šè¾¹å½¢æŸ¥è¯¢
    æ€§èƒ½ï¼šæœ€å¿«ï¼ˆ100-1000xï¼‰
    
    Rtreeä½¿ç”¨åŠ¨æ€è¾¹ç•Œä½“ç§¯æ ‘ï¼Œä¸“é—¨ä¸ºç©ºé—´æŸ¥è¯¢ä¼˜åŒ–
    """
    def __init__(self, polygons_dict):
        """åˆå§‹åŒ–Ræ ‘ç´¢å¼•"""
        try:
            from shapely.strtree import STRtree
        except ImportError:
            print("âš ï¸ éœ€è¦ shapely >= 2.0ï¼Œä½¿ç”¨ pip install --upgrade shapely")
            raise
        
        self.polygons = {}
        self.geometry_list = []
        self.name_list = []
        
        # æ„å»ºå‡ ä½•ä½“åˆ—è¡¨ç”¨äºRæ ‘
        for name, coords in polygons_dict.items():
            polygon = Polygon(coords)
            self.polygons[name] = polygon
            self.geometry_list.append(polygon)
            self.name_list.append(name)
        
        # åˆ›å»ºRæ ‘ç´¢å¼•
        self.tree = STRtree(self.geometry_list)
    
    def find_point_in_polygons(self, point_lon, point_lat):
        """
        ä½¿ç”¨Ræ ‘æŸ¥è¯¢ç‚¹æ‰€åœ¨çš„å¤šè¾¹å½¢
        """
        point = Point(point_lon, point_lat)
        result = []
        
        # Ræ ‘æŸ¥è¯¢ï¼šè·å–å¯èƒ½åŒ…å«è¯¥ç‚¹çš„å¤šè¾¹å½¢ç´¢å¼•
        candidates_idx = self.tree.query(point, predicate='intersects')
        
        # ç²¾ç¡®æ£€æŸ¥ï¼ˆå› ä¸ºintersectsåªæ˜¯ç²—ç•¥æ£€æŸ¥ï¼‰
        for idx in candidates_idx:
            if self.geometry_list[idx].contains(point):
                result.append(self.name_list[idx])
        
        return result
    
    def find_points_in_polygons_batch(self, points_list):
        """æ‰¹é‡æŸ¥è¯¢"""
        results = []
        for lon, lat in points_list:
            polygons = self.find_point_in_polygons(lon, lat)
            results.append({"point": (lon, lat), "polygons": polygons})
        return results
```

### 4ï¸âƒ£ æ€§èƒ½è¡¨ç°

åœ¨ç¤ºä¾‹ä»£ç ä¸­ï¼Œä½¿ç”¨ï¼š

- 1000 ä¸ªå¤šè¾¹å½¢
- 500 ä¸ªæŸ¥è¯¢ç‚¹

æµ‹è¯•ç»“æœï¼š

> **å¤šè¾¹å½¢è¶Šå¤šï¼ŒR æ ‘ä¼˜åŠ¿è¶Šæ˜æ˜¾ã€‚**

<img src="3-Ræ ‘ç´¢å¼•.assets\image-20260127163911191.png" alt="image-20260127163911191" style="zoom: 67%;" />



## å››ã€ä¸‰ç§æ–¹æ¡ˆçš„å¯¹æ¯”æ€»ç»“

| æ–¹æ³•       | æ—¶é—´å¤æ‚åº¦ | æ„å»ºæˆæœ¬ | æŸ¥è¯¢é€Ÿåº¦ | é€‚ç”¨åœºæ™¯           |
| ---------- | ---------- | -------- | -------- | ------------------ |
| ç›´æ¥éå†   | O(N)       | æ—        | æ…¢       | å°æ•°æ®ã€ä¸€æ¬¡æ€§åˆ†æ |
| åŒ…å›´ç›’è¿‡æ»¤ | O(N)       | æä½     | ä¸­       | ä¸­ç­‰è§„æ¨¡å›´æ        |
| R æ ‘ç´¢å¼•   | O(log N)   | ä¸­       | æå¿«     | å¤§è§„æ¨¡ã€å®æ—¶åœºæ™¯   |

------

## äº”ã€å·¥ç¨‹é€‰å‹å»ºè®®

-  å¤šè¾¹å½¢ < 100 ä¸ªï¼š ç›´æ¥ contains åˆ¤æ–­
- å¤šè¾¹å½¢ 100 ~ 1000ï¼š åŒ…å›´ç›’è¿‡æ»¤
- å¤šè¾¹å½¢ > 1000ï¼š R æ ‘ç´¢å¼•ï¼ˆå¼ºçƒˆæ¨èï¼‰